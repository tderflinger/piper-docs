<!DOCTYPE html><html lang="en" dir="ltr" data-theme="dark" data-has-toc data-has-sidebar class="astro-bguv2lll"> <head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>piper.cpp | Piper Documentation</title><link rel="canonical" href="https://tderflinger.github.io/piper-docs/codereading/cpp/piper/"/><link rel="sitemap" href="/piper-docs/sitemap-index.xml"/><link rel="shortcut icon" href="/piper-docs/favicon.svg" type="image/svg+xml"/><meta name="generator" content="Astro v5.5.3"/><meta name="generator" content="Starlight v0.32.3"/><meta property="og:title" content="piper.cpp"/><meta property="og:type" content="article"/><meta property="og:url" content="https://tderflinger.github.io/piper-docs/codereading/cpp/piper/"/><meta property="og:locale" content="en"/><meta property="og:description" content="piper.cpp"/><meta property="og:site_name" content="Piper Documentation"/><meta name="twitter:card" content="summary_large_image"/><meta name="description" content="piper.cpp"/><script>
	window.StarlightThemeProvider = (() => {
		const storedTheme =
			typeof localStorage !== 'undefined' && localStorage.getItem('starlight-theme');
		const theme =
			storedTheme ||
			(window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
		document.documentElement.dataset.theme = theme === 'light' ? 'light' : 'dark';
		return {
			updatePickers(theme = storedTheme || 'auto') {
				document.querySelectorAll('starlight-theme-select').forEach((picker) => {
					const select = picker.querySelector('select');
					if (select) select.value = theme;
					/** @type {HTMLTemplateElement | null} */
					const tmpl = document.querySelector(`#theme-icons`);
					const newIcon = tmpl && tmpl.content.querySelector('.' + theme);
					if (newIcon) {
						const oldIcon = picker.querySelector('svg.label-icon');
						if (oldIcon) {
							oldIcon.replaceChildren(...newIcon.cloneNode(true).childNodes);
						}
					}
				});
			},
		};
	})();
</script><template id="theme-icons"><svg aria-hidden="true" class="light astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M5 12a1 1 0 0 0-1-1H3a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1Zm.64 5-.71.71a1 1 0 0 0 0 1.41 1 1 0 0 0 1.41 0l.71-.71A1 1 0 0 0 5.64 17ZM12 5a1 1 0 0 0 1-1V3a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm5.66 2.34a1 1 0 0 0 .7-.29l.71-.71a1 1 0 1 0-1.41-1.41l-.66.71a1 1 0 0 0 0 1.41 1 1 0 0 0 .66.29Zm-12-.29a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.71-.71a1.004 1.004 0 1 0-1.43 1.41l.73.71ZM21 11h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2Zm-2.64 6A1 1 0 0 0 17 18.36l.71.71a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.76-.66ZM12 6.5a5.5 5.5 0 1 0 5.5 5.5A5.51 5.51 0 0 0 12 6.5Zm0 9a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm0 3.5a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg> <svg aria-hidden="true" class="dark astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.64 13a1 1 0 0 0-1.05-.14 8.049 8.049 0 0 1-3.37.73 8.15 8.15 0 0 1-8.14-8.1 8.59 8.59 0 0 1 .25-2A1 1 0 0 0 8 2.36a10.14 10.14 0 1 0 14 11.69 1 1 0 0 0-.36-1.05Zm-9.5 6.69A8.14 8.14 0 0 1 7.08 5.22v.27a10.15 10.15 0 0 0 10.14 10.14 9.784 9.784 0 0 0 2.1-.22 8.11 8.11 0 0 1-7.18 4.32v-.04Z"/></svg> <svg aria-hidden="true" class="auto astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> </template><link rel="stylesheet" href="/piper-docs/_astro/print.BJ0teN4y.css" media="print"><link rel="stylesheet" href="/piper-docs/_astro/index.-0NCauzY.css">
<style>:root{--sl-badge-default-border: var(--sl-color-accent);--sl-badge-default-bg: var(--sl-color-accent-low);--sl-badge-default-text: #fff;--sl-badge-note-border: var(--sl-color-blue);--sl-badge-note-bg: var(--sl-color-blue-low);--sl-badge-note-text: #fff;--sl-badge-danger-border: var(--sl-color-red);--sl-badge-danger-bg: var(--sl-color-red-low);--sl-badge-danger-text: #fff;--sl-badge-success-border: var(--sl-color-green);--sl-badge-success-bg: var(--sl-color-green-low);--sl-badge-success-text: #fff;--sl-badge-caution-border: var(--sl-color-orange);--sl-badge-caution-bg: var(--sl-color-orange-low);--sl-badge-caution-text: #fff;--sl-badge-tip-border: var(--sl-color-purple);--sl-badge-tip-bg: var(--sl-color-purple-low);--sl-badge-tip-text: #fff}[data-theme=light]:root{--sl-badge-default-bg: var(--sl-color-accent-high);--sl-badge-note-bg: var(--sl-color-blue-high);--sl-badge-danger-bg: var(--sl-color-red-high);--sl-badge-success-bg: var(--sl-color-green-high);--sl-badge-caution-bg: var(--sl-color-orange-high);--sl-badge-tip-bg: var(--sl-color-purple-high)}.sl-badge:where(.astro-avdet4wd){display:inline-block;border:1px solid var(--sl-color-border-badge);border-radius:.25rem;font-family:var(--sl-font-system-mono);line-height:normal;color:var(--sl-color-text-badge);background-color:var(--sl-color-bg-badge);overflow-wrap:anywhere}.sidebar-content .sl-badge:where(.astro-avdet4wd){line-height:1;font-size:var(--sl-text-xs);padding:.125rem .375rem}.sidebar-content a[aria-current=page]>.sl-badge:where(.astro-avdet4wd){--sl-color-bg-badge: transparent;--sl-color-border-badge: currentColor;color:inherit}.default:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-default-bg);--sl-color-border-badge: var(--sl-badge-default-border);--sl-color-text-badge: var(--sl-badge-default-text)}.note:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-note-bg);--sl-color-border-badge: var(--sl-badge-note-border);--sl-color-text-badge: var(--sl-badge-note-text)}.danger:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-danger-bg);--sl-color-border-badge: var(--sl-badge-danger-border);--sl-color-text-badge: var(--sl-badge-danger-text)}.success:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-success-bg);--sl-color-border-badge: var(--sl-badge-success-border);--sl-color-text-badge: var(--sl-badge-success-text)}.tip:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-tip-bg);--sl-color-border-badge: var(--sl-badge-tip-border);--sl-color-text-badge: var(--sl-badge-tip-text)}.caution:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-caution-bg);--sl-color-border-badge: var(--sl-badge-caution-border);--sl-color-text-badge: var(--sl-badge-caution-text)}.small:where(.astro-avdet4wd){font-size:var(--sl-text-xs);padding:.125rem .25rem}.medium:where(.astro-avdet4wd){font-size:var(--sl-text-sm);padding:.175rem .35rem}.large:where(.astro-avdet4wd){font-size:var(--sl-text-base);padding:.225rem .45rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) .sl-badge:where(.astro-avdet4wd){vertical-align:middle}
.card-grid:where(.astro-zntqmydn){display:grid;grid-template-columns:100%;gap:1rem}.card-grid:where(.astro-zntqmydn)>*{margin-top:0!important}@media (min-width: 50rem){.card-grid:where(.astro-zntqmydn){grid-template-columns:1fr 1fr;gap:1.5rem}.stagger:where(.astro-zntqmydn){--stagger-height: 5rem;padding-bottom:var(--stagger-height)}.stagger:where(.astro-zntqmydn)>*:nth-child(2n){transform:translateY(var(--stagger-height))}}
.card:where(.astro-v5tidmuc){--sl-card-border: var(--sl-color-purple);--sl-card-bg: var(--sl-color-purple-low);border:1px solid var(--sl-color-gray-5);background-color:var(--sl-color-black);padding:clamp(1rem,calc(.125rem + 3vw),2.5rem);flex-direction:column;gap:clamp(.5rem,calc(.125rem + 1vw),1rem)}.card:where(.astro-v5tidmuc):nth-child(4n+1){--sl-card-border: var(--sl-color-orange);--sl-card-bg: var(--sl-color-orange-low)}.card:where(.astro-v5tidmuc):nth-child(4n+3){--sl-card-border: var(--sl-color-green);--sl-card-bg: var(--sl-color-green-low)}.card:where(.astro-v5tidmuc):nth-child(4n+4){--sl-card-border: var(--sl-color-red);--sl-card-bg: var(--sl-color-red-low)}.card:where(.astro-v5tidmuc):nth-child(4n+5){--sl-card-border: var(--sl-color-blue);--sl-card-bg: var(--sl-color-blue-low)}.title:where(.astro-v5tidmuc){font-weight:600;font-size:var(--sl-text-h4);color:var(--sl-color-white);line-height:var(--sl-line-height-headings);gap:1rem;align-items:center}.card:where(.astro-v5tidmuc) .icon:where(.astro-v5tidmuc){border:1px solid var(--sl-card-border);background-color:var(--sl-card-bg);padding:.2em;border-radius:.25rem}.card:where(.astro-v5tidmuc) .body:where(.astro-v5tidmuc){margin:0;font-size:clamp(var(--sl-text-sm),calc(.5rem + 1vw),var(--sl-text-body))}
svg:where(.astro-c6vsoqas){color:var(--sl-icon-color);font-size:var(--sl-icon-size, 1em);width:1em;height:1em}
.sl-steps{--bullet-size: calc(var(--sl-line-height) * 1rem);--bullet-margin: .375rem;list-style:none;counter-reset:steps-counter var(--sl-steps-start, 0);padding-inline-start:0}.sl-steps>li{counter-increment:steps-counter;position:relative;padding-inline-start:calc(var(--bullet-size) + 1rem);padding-bottom:1px;min-height:calc(var(--bullet-size) + var(--bullet-margin))}.sl-steps>li+li{margin-top:0}.sl-steps>li:before{content:counter(steps-counter);position:absolute;top:0;inset-inline-start:0;width:var(--bullet-size);height:var(--bullet-size);line-height:var(--bullet-size);font-size:var(--sl-text-xs);font-weight:600;text-align:center;color:var(--sl-color-white);background-color:var(--sl-color-gray-6);border-radius:99rem;box-shadow:inset 0 0 0 1px var(--sl-color-gray-5)}.sl-steps>li:after{--guide-width: 1px;content:"";position:absolute;top:calc(var(--bullet-size) + var(--bullet-margin));bottom:var(--bullet-margin);inset-inline-start:calc((var(--bullet-size) - var(--guide-width)) / 2);width:var(--guide-width);background-color:var(--sl-color-hairline-light)}.sl-steps>li>:first-child{--lh: calc(1em * var(--sl-line-height));--shift-y: calc(.5 * (var(--bullet-size) - var(--lh)));transform:translateY(var(--shift-y));margin-bottom:var(--shift-y)}.sl-steps>li>:first-child:where(h1,h2,h3,h4,h5,h6){--lh: calc(1em * var(--sl-line-height-headings))}@supports (--prop: 1lh){.sl-steps>li>:first-child{--lh: 1lh}}
.sl-link-button:where(.astro-xwgiixxa){align-items:center;border:1px solid transparent;border-radius:999rem;display:inline-flex;font-size:var(--sl-text-sm);gap:.5em;line-height:1.1875;outline-offset:.25rem;padding:.4375rem 1.125rem;text-decoration:none}.sl-link-button:where(.astro-xwgiixxa).primary{background:var(--sl-color-text-accent);border-color:var(--sl-color-text-accent);color:var(--sl-color-black)}.sl-link-button:where(.astro-xwgiixxa).primary:hover{color:var(--sl-color-black)}.sl-link-button:where(.astro-xwgiixxa).secondary{border-color:inherit;color:var(--sl-color-white)}.sl-link-button:where(.astro-xwgiixxa).minimal{color:var(--sl-color-white);padding-inline:0}.sl-link-button:where(.astro-xwgiixxa) svg{flex-shrink:0}@media (min-width: 50rem){.sl-link-button:where(.astro-xwgiixxa){font-size:var(--sl-text-base);padding:.9375rem 1.25rem}}.sl-markdown-content .sl-link-button:where(.astro-xwgiixxa){margin-inline-end:1rem}.sl-markdown-content .sl-link-button:where(.astro-xwgiixxa):not(:where(p *)){margin-block:1rem}
</style><script type="module" src="/piper-docs/_astro/page.7qqag-5g.js"></script></head> <body class="astro-bguv2lll"> <a href="#_top" class="astro-7q3lir66">Skip to content</a>  <div class="page sl-flex astro-vrdttmbt"> <header class="header astro-vrdttmbt"><div class="header sl-flex astro-kmkmnagf"> <div class="title-wrapper sl-flex astro-kmkmnagf"> <a href="/piper-docs/" class="site-title sl-flex astro-m46x6ez3">  <span class="astro-m46x6ez3" translate="no"> Piper Documentation </span> </a>  </div> <div class="sl-flex print:hidden astro-kmkmnagf"> <site-search class="astro-kmkmnagf astro-v37mnknz" data-translations="{&#34;placeholder&#34;:&#34;Search&#34;}"> <button data-open-modal disabled aria-label="Search" aria-keyshortcuts="Control+K" class="astro-v37mnknz"> <svg aria-hidden="true" class="astro-v37mnknz astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.71 20.29 18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z"/></svg>  <span class="sl-hidden md:sl-block astro-v37mnknz" aria-hidden="true">Search</span> <kbd class="sl-hidden md:sl-flex astro-v37mnknz" style="display: none;"> <kbd class="astro-v37mnknz">Ctrl</kbd><kbd class="astro-v37mnknz">K</kbd> </kbd> </button> <dialog style="padding:0" aria-label="Search" class="astro-v37mnknz"> <div class="dialog-frame sl-flex astro-v37mnknz">  <button data-close-modal class="sl-flex md:sl-hidden astro-v37mnknz"> Cancel </button> <div class="search-container astro-v37mnknz"> <div id="starlight__search" class="astro-v37mnknz"></div> </div> </div> </dialog> </site-search>  <script>
	(() => {
		const openBtn = document.querySelector('button[data-open-modal]');
		const shortcut = openBtn?.querySelector('kbd');
		if (!openBtn || !(shortcut instanceof HTMLElement)) return;
		const platformKey = shortcut.querySelector('kbd');
		if (platformKey && /(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)) {
			platformKey.textContent = '⌘';
			openBtn.setAttribute('aria-keyshortcuts', 'Meta+K');
		}
		shortcut.style.display = '';
	})();
</script> <script type="module" src="/piper-docs/_astro/Search.astro_astro_type_script_index_0_lang.CLtx1Xk7.js"></script>   </div> <div class="sl-hidden md:sl-flex print:hidden right-group astro-kmkmnagf"> <div class="sl-flex social-icons astro-kmkmnagf"> <a href="https://github.com/withastro/starlight" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">GitHub</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg> </a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-4yphtoen"> <span class="sr-only astro-4yphtoen">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg>  <select value="auto" autocomplete="off" class="astro-4yphtoen"> <option value="dark" class="astro-4yphtoen">Dark</option><option value="light" class="astro-4yphtoen">Light</option><option value="auto" selected class="astro-4yphtoen">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script> <script type="module">const r="starlight-theme",o=e=>e==="auto"||e==="dark"||e==="light"?e:"auto",c=()=>o(typeof localStorage<"u"&&localStorage.getItem(r));function n(e){typeof localStorage<"u"&&localStorage.setItem(r,e==="light"||e==="dark"?e:"")}const l=()=>matchMedia("(prefers-color-scheme: light)").matches?"light":"dark";function t(e){StarlightThemeProvider.updatePickers(e),document.documentElement.dataset.theme=e==="auto"?l():e,n(e)}matchMedia("(prefers-color-scheme: light)").addEventListener("change",()=>{c()==="auto"&&t("auto")});class s extends HTMLElement{constructor(){super(),t(c()),this.querySelector("select")?.addEventListener("change",a=>{a.currentTarget instanceof HTMLSelectElement&&t(o(a.currentTarget.value))})}}customElements.define("starlight-theme-select",s);</script> <script type="module">class s extends HTMLElement{constructor(){super();const e=this.querySelector("select");e&&(e.addEventListener("change",t=>{t.currentTarget instanceof HTMLSelectElement&&(window.location.pathname=t.currentTarget.value)}),window.addEventListener("pageshow",t=>{if(!t.persisted)return;const n=e.querySelector("option[selected]")?.index;n!==e.selectedIndex&&(e.selectedIndex=n??0)}))}}customElements.define("starlight-lang-select",s);</script> </div> </div> </header> <nav class="sidebar print:hidden astro-vrdttmbt" aria-label="Main"> <starlight-menu-button class="print:hidden astro-jif73yzw"> <button aria-expanded="false" aria-label="Menu" aria-controls="starlight__sidebar" class="sl-flex md:sl-hidden astro-jif73yzw"> <svg aria-hidden="true" class="astro-jif73yzw astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z"/></svg>  </button> </starlight-menu-button> <script type="module">class s extends HTMLElement{constructor(){super(),this.btn=this.querySelector("button"),this.btn.addEventListener("click",()=>this.toggleExpanded());const t=this.closest("nav");t&&t.addEventListener("keyup",e=>this.closeOnEscape(e))}setExpanded(t){this.setAttribute("aria-expanded",String(t)),document.body.toggleAttribute("data-mobile-menu-expanded",t)}toggleExpanded(){this.setExpanded(this.getAttribute("aria-expanded")!=="true")}closeOnEscape(t){t.code==="Escape"&&(this.setExpanded(!1),this.btn.focus())}}customElements.define("starlight-menu-button",s);</script>   <div id="starlight__sidebar" class="sidebar-pane astro-vrdttmbt"> <div class="sidebar-content sl-flex astro-vrdttmbt"> <sl-sidebar-state-persist data-hash="00plfdl" class="astro-kku4brbg"> <script aria-hidden="true">
		(() => {
			try {
				if (!matchMedia('(min-width: 50em)').matches) return;
				/** @type {HTMLElement | null} */
				const target = document.querySelector('sl-sidebar-state-persist');
				const state = JSON.parse(sessionStorage.getItem('sl-sidebar-state') || '0');
				if (!target || !state || target.dataset.hash !== state.hash) return;
				window._starlightScrollRestore = state.scroll;
				customElements.define(
					'sl-sidebar-restore',
					class SidebarRestore extends HTMLElement {
						connectedCallback() {
							try {
								const idx = parseInt(this.dataset.index || '');
								const details = this.closest('details');
								if (details && typeof state.open[idx] === 'boolean') details.open = state.open[idx];
							} catch {}
						}
					}
				);
			} catch {}
		})();
	</script>  <ul class="top-level astro-3ii7xxms"> <li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="0"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">About</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/about/intro/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Introduction</span>  </a> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="1"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Voices</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/about/voices/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Available Voices</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/about/voices/download/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Download Voices</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/about/dependencies/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Dependencies</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/about/project_use/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">People Using Piper</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="2"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Guides</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/guides/installation/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Installation Guide</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/guides/usage/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Usage Guide</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/guides/training/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Training Guide</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="3"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Code Reading</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/intro/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Introduction</span>  </a> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="4"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">cpp</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/cpp/main/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">main.cpp</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/cpp/piper/" aria-current="page" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">piper.cpp</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="5"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">python_run</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python_run/piper/main/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">__main__.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python_run/piper/config/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">config.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python_run/piper/download/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">download.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python_run/piper/file_hash/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">file_hash.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python_run/piper/http_server/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">http_server.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python_run/piper/util/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">util.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python_run/piper/voice/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">voice.py</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="6"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">piper_train</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/main/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">__main__.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/check_phonemes/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">check_phonemes.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/clean_cached_audio/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">clean_cached_audio.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/export_generator/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">export_generator.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/export_onnx_streaming/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">export_onnx_streaming.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/export_onnx/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">export_onnx.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/export_torchscript/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">export_torchscript.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/filter_utterances/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">filter_utterances.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/infer_generator/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">infer_generator.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/infer_onnx_streaming/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">infer_onnx_streaming.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/infer_onnx/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">infer_onnx.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/infer_torchscript/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">infer_torchscript.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/infer/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">infer.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/preprocess/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">preprocess.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/select_speaker/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">select_speaker.py</span>  </a> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <sl-sidebar-restore data-index="7"></sl-sidebar-restore> <summary class="astro-3ii7xxms"> <div class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">vits</span>  </div> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/attentions/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">attentions.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/commons/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">commmons.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/config/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">config.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/dataset/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">dataset.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/lightning/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">lightning.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/losses/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">losses.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/mel_processing/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">mel_processing.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/models/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">models.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/modules/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">modules.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/transforms/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">transforms.py</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/piper-docs/codereading/python/piper_train/vits/utils/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">utils.py</span>  </a> </li> </ul>  </details> </li> </ul>  </details> </li> </ul>  </details> </li> </ul>   <script aria-hidden="true">
		(() => {
			const scroller = document.getElementById('starlight__sidebar');
			if (!window._starlightScrollRestore || !scroller) return;
			scroller.scrollTop = window._starlightScrollRestore;
			delete window._starlightScrollRestore;
		})();
	</script> </sl-sidebar-state-persist>  <div class="md:sl-hidden"> <div class="mobile-preferences sl-flex astro-wu23bvmt"> <div class="sl-flex social-icons astro-wu23bvmt"> <a href="https://github.com/withastro/starlight" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">GitHub</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg> </a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-4yphtoen"> <span class="sr-only astro-4yphtoen">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg>  <select value="auto" autocomplete="off" class="astro-4yphtoen"> <option value="dark" class="astro-4yphtoen">Dark</option><option value="light" class="astro-4yphtoen">Light</option><option value="auto" selected class="astro-4yphtoen">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script>   </div>  </div> </div> </div> </nav> <div class="main-frame astro-vrdttmbt">  <script type="module">const a=document.getElementById("starlight__sidebar"),n=a?.querySelector("sl-sidebar-state-persist"),o="sl-sidebar-state",i=()=>{let t=[];const e=n?.dataset.hash||"";try{const s=sessionStorage.getItem(o),r=JSON.parse(s||"{}");Array.isArray(r.open)&&r.hash===e&&(t=r.open)}catch{}return{hash:e,open:t,scroll:a?.scrollTop||0}},c=t=>{try{sessionStorage.setItem(o,JSON.stringify(t))}catch{}},d=()=>c(i()),l=(t,e)=>{const s=i();s.open[e]=t,c(s)};n?.addEventListener("click",t=>{if(!(t.target instanceof Element))return;const e=t.target.closest("summary")?.closest("details");if(!e)return;const s=e.querySelector("sl-sidebar-restore"),r=parseInt(s?.dataset.index||"");isNaN(r)||l(!e.open,r)});addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&d()});addEventListener("pageHide",d);</script> <div class="lg:sl-flex astro-67yu43on"> <aside class="right-sidebar-container print:hidden astro-67yu43on"> <div class="right-sidebar astro-67yu43on"> <div class="lg:sl-hidden astro-pb3aqygn"><mobile-starlight-toc data-min-h="2" data-max-h="3" class="astro-doynk5tl"><nav aria-labelledby="starlight__on-this-page--mobile" class="astro-doynk5tl"><details id="starlight__mobile-toc" class="astro-doynk5tl"><summary id="starlight__on-this-page--mobile" class="sl-flex astro-doynk5tl"><div class="toggle sl-flex astro-doynk5tl">On this page<svg aria-hidden="true" class="caret astro-doynk5tl astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </div><span class="display-current astro-doynk5tl"></span></summary><div class="dropdown astro-doynk5tl"><ul class="isMobile astro-g2bywc46" style="--depth: 0;"> <li class="astro-g2bywc46" style="--depth: 0;"> <a href="#_top" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#code-explained" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Code Explained</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#1-header-inclusions" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">1. Header Inclusions</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#2-constants-and-utility-functions" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">2. Constants and Utility Functions</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#3-configuration-parsing" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">3. Configuration Parsing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#4-initialization-and-termination" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">4. Initialization and Termination</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#5-model-loading" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">5. Model Loading</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#6-audio-synthesis" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6. Audio Synthesis</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#7-integration-of-components" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7. Integration of Components</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#use-case" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Use Case</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#source-code" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Source Code</span> </a>  </li> </ul> </div></details></nav></mobile-starlight-toc><script type="module" src="/piper-docs/_astro/MobileTableOfContents.astro_astro_type_script_index_0_lang.C181hMzK.js"></script></div><div class="right-sidebar-panel sl-hidden lg:sl-block astro-pb3aqygn"><div class="sl-container astro-pb3aqygn"><starlight-toc data-min-h="2" data-max-h="3"><nav aria-labelledby="starlight__on-this-page"><h2 id="starlight__on-this-page">On this page</h2><ul class="astro-g2bywc46" style="--depth: 0;"> <li class="astro-g2bywc46" style="--depth: 0;"> <a href="#_top" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#code-explained" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Code Explained</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#1-header-inclusions" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">1. Header Inclusions</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#2-constants-and-utility-functions" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">2. Constants and Utility Functions</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#3-configuration-parsing" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">3. Configuration Parsing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#4-initialization-and-termination" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">4. Initialization and Termination</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#5-model-loading" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">5. Model Loading</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#6-audio-synthesis" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6. Audio Synthesis</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#7-integration-of-components" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7. Integration of Components</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#use-case" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Use Case</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#source-code" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Source Code</span> </a>  </li> </ul> </nav></starlight-toc><script type="module" src="/piper-docs/_astro/TableOfContents.astro_astro_type_script_index_0_lang.CKWWgpjV.js"></script></div></div> </div> </aside> <div class="main-pane astro-67yu43on">  <main data-pagefind-body class="astro-bguv2lll" lang="en" dir="ltr">    <div class="content-panel astro-7nkwcw3z"> <div class="sl-container astro-7nkwcw3z"> <h1 id="_top" class="astro-j6tvhyss">piper.cpp</h1>  </div> </div>  <div class="content-panel astro-7nkwcw3z"> <div class="sl-container astro-7nkwcw3z"> <div class="sl-markdown-content"> <h2 id="code-explained">Code Explained</h2>
<p>The provided code implements the core functionality of a text-to-speech (TTS) system within the <code dir="auto">piper</code> namespace. It integrates multiple components, including phoneme processing, audio synthesis, and configuration parsing, to convert text into synthesized speech. Here’s a detailed explanation of the active selection:</p>
<hr>
<h3 id="1-header-inclusions"><strong>1. Header Inclusions</strong></h3>
<p>The code begins by including various standard and third-party libraries:</p>
<ul>
<li><strong>Standard Libraries</strong>: Includes utilities like <code dir="auto">&#x3C;array></code>, <code dir="auto">&#x3C;chrono></code>, <code dir="auto">&#x3C;fstream></code>, <code dir="auto">&#x3C;sstream></code>, and <code dir="auto">&#x3C;stdexcept></code> for handling data structures, file I/O, and error handling.</li>
<li><strong>Third-Party Libraries</strong>:
<ul>
<li><code dir="auto">espeak-ng/speak_lib.h</code>: Provides phoneme generation using the eSpeak-NG library.</li>
<li><code dir="auto">onnxruntime_cxx_api.h</code>: Enables inference using ONNX Runtime for neural network models.</li>
<li><code dir="auto">spdlog/spdlog.h</code>: Facilitates logging for debugging and runtime information.</li>
<li><code dir="auto">json.hpp</code>: A JSON library (nlohmann::json) for parsing and handling configuration files.</li>
<li><code dir="auto">utf8.h</code>: Handles UTF-8 string manipulation.</li>
<li><code dir="auto">wavfile.hpp</code>: Manages WAV file creation and header writing.</li>
</ul>
</li>
</ul>
<p>These libraries collectively support the TTS pipeline, from text processing to audio output.</p>
<hr>
<h3 id="2-constants-and-utility-functions"><strong>2. Constants and Utility Functions</strong></h3>
<ul>
<li>
<p><strong>Constants</strong>:</p>
<ul>
<li><code dir="auto">MAX_WAV_VALUE</code>: Defines the maximum amplitude for 16-bit signed WAV samples, used for audio scaling.</li>
<li><code dir="auto">instanceName</code>: A string identifier for the ONNX Runtime environment.</li>
</ul>
</li>
<li>
<p><strong>Version Handling</strong>:</p>
<ul>
<li>The VERSION constant is conditionally defined using the <code dir="auto">_PIPER_VERSION</code> macro, allowing the application to embed its version during compilation.</li>
</ul>
</li>
<li>
<p><strong>Utility Functions</strong>:</p>
<ul>
<li><code dir="auto">getVersion()</code>: Returns the version string of the application.</li>
<li><code dir="auto">isSingleCodepoint(std::string s)</code>: Checks if a string represents a single UTF-8 codepoint.</li>
<li><code dir="auto">getCodepoint(std::string s)</code>: Extracts the first UTF-8 codepoint from a string.</li>
</ul>
</li>
</ul>
<p>These utilities simplify version management and UTF-8 string handling, which are critical for phoneme processing.</p>
<hr>
<h3 id="3-configuration-parsing"><strong>3. Configuration Parsing</strong></h3>
<p>The code provides functions to parse JSON configuration files for different aspects of the TTS system:</p>
<ul>
<li>
<p><strong><code dir="auto">parsePhonemizeConfig</code></strong>:</p>
<ul>
<li>Parses phonemization-related settings, such as the eSpeak voice, phoneme type, and mappings between phonemes and IDs.</li>
<li>Validates that phonemes are single UTF-8 codepoints and throws errors for invalid configurations.</li>
</ul>
</li>
<li>
<p><strong><code dir="auto">parseSynthesisConfig</code></strong>:</p>
<ul>
<li>Parses audio synthesis settings, including sample rate, noise scale, length scale, and phoneme-specific silence durations.</li>
<li>Ensures that phoneme keys in the silence map are valid UTF-8 codepoints.</li>
</ul>
</li>
<li>
<p><strong><code dir="auto">parseModelConfig</code></strong>:</p>
<ul>
<li>Parses model-specific settings, such as the number of speakers and a mapping of speaker names to IDs.</li>
</ul>
</li>
</ul>
<p>These functions ensure that the TTS system is configured correctly and can handle various input formats and settings.</p>
<hr>
<h3 id="4-initialization-and-termination"><strong>4. Initialization and Termination</strong></h3>
<ul>
<li>
<p><strong><code dir="auto">initialize</code></strong>:</p>
<ul>
<li>Initializes the eSpeak-NG library if phonemization is enabled.</li>
<li>Loads the <code dir="auto">libtashkeel</code> model for Arabic text diacritization if required.</li>
</ul>
</li>
<li>
<p><strong><code dir="auto">terminate</code></strong>:</p>
<ul>
<li>Cleans up resources, such as terminating the eSpeak-NG library.</li>
</ul>
</li>
</ul>
<p>These functions manage the lifecycle of external dependencies, ensuring proper setup and teardown.</p>
<hr>
<h3 id="5-model-loading"><strong>5. Model Loading</strong></h3>
<ul>
<li>
<p><strong><code dir="auto">loadModel</code></strong>:</p>
<ul>
<li>Loads an ONNX model for speech synthesis using ONNX Runtime.</li>
<li>Configures the runtime environment, including optional CUDA support for GPU acceleration.</li>
<li>Disables certain optimizations to balance performance and compatibility.</li>
</ul>
</li>
<li>
<p><strong><code dir="auto">loadVoice</code></strong>:</p>
<ul>
<li>Combines model loading with configuration parsing.</li>
<li>Loads the voice model and its associated JSON configuration, applying settings like speaker ID and phoneme mappings.</li>
</ul>
</li>
</ul>
<p>These functions prepare the neural network model and its configuration for inference.</p>
<hr>
<h3 id="6-audio-synthesis"><strong>6. Audio Synthesis</strong></h3>
<ul>
<li>
<p><strong><code dir="auto">synthesize</code></strong>:</p>
<ul>
<li>Converts phoneme IDs into audio samples using the ONNX model.</li>
<li>Scales the audio to fit the 16-bit WAV range and stores it in an <code dir="auto">audioBuffer</code>.</li>
<li>Measures inference time and calculates the real-time factor (synthesis speed relative to audio duration).</li>
</ul>
</li>
<li>
<p><strong><code dir="auto">textToAudio</code></strong>:</p>
<ul>
<li>Converts text into phonemes and synthesizes audio for each sentence.</li>
<li>Handles phoneme-to-ID mapping, phrase splitting, and silence insertion.</li>
<li>Supports callbacks for streaming audio during synthesis.</li>
</ul>
</li>
<li>
<p><strong><code dir="auto">textToWavFile</code></strong>:</p>
<ul>
<li>Synthesizes audio from text and writes it to a WAV file.</li>
<li>Uses <code dir="auto">textToAudio</code> for synthesis and <code dir="auto">writeWavHeader</code> for WAV file formatting.</li>
</ul>
</li>
</ul>
<p>These functions form the core of the TTS pipeline, transforming text into high-quality speech.</p>
<hr>
<h3 id="7-integration-of-components"><strong>7. Integration of Components</strong></h3>
<p>The code integrates multiple components to create a flexible and extensible TTS system:</p>
<ul>
<li><strong>Phonemization</strong>: Supports both eSpeak-NG and direct UTF-8 codepoints.</li>
<li><strong>Neural Network Inference</strong>: Uses ONNX Runtime for efficient speech synthesis.</li>
<li><strong>Configuration</strong>: Reads JSON files to customize behavior, enabling multi-speaker models and language-specific features.</li>
<li><strong>Audio Output</strong>: Produces WAV files or streams audio directly, supporting various use cases.</li>
</ul>
<hr>
<h3 id="use-case"><strong>Use Case</strong></h3>
<p>This code is designed for a TTS application that can handle multiple languages, speakers, and configurations. It is suitable for real-time systems, batch processing, and integration into larger applications. The modular design allows easy extension with new features, such as additional phonemization methods or synthesis models.</p>
<h2 id="source-code">Source Code</h2>
<div class="expressive-code"><link rel="stylesheet" href="/piper-docs/_astro/ec.tm3va.css"><script type="module" src="/piper-docs/_astro/ec.8zarh.js"></script><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="cpp"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">array</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">chrono</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">fstream</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">limits</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">sstream</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">stdexcept</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">espeak-ng/speak_lib.h</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">onnxruntime_cxx_api.h</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">&#x3C;</span><span style="--0:#ECC48D;--1:#984E4D">spdlog/spdlog.h</span><span style="--0:#D9F5DD;--1:#111111">></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">json.hpp</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">piper.hpp</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">utf8.h</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#include</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">wavfile.hpp</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">namespace</span><span style="--0:#D6DEEB;--1:#403F53"> piper {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#ifdef</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">_PIPER_VERSION</span></div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// https://stackoverflow.com/questions/47346133/how-to-use-a-define-inside-a-format-string</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#define</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">_STR</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#D7DBE0;--1:#403F53">x</span><span style="--0:#D9F5DD;--1:#111111">)</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">#x</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#define</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">STR</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#D7DBE0;--1:#403F53">x</span><span style="--0:#D9F5DD;--1:#111111">)</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">_STR</span><span style="--0:#D6DEEB;--1:#403F53">(x)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">const</span><span style="--0:#D6DEEB;--1:#403F53"> std::string VERSION </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">STR</span><span style="--0:#D6DEEB;--1:#403F53">(_PIPER_VERSION);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#else</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">const</span><span style="--0:#D6DEEB;--1:#403F53"> std::string VERSION </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">""</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#endif</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Maximum value for 16-bit signed WAV sample</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">const</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">float</span><span style="--0:#D6DEEB;--1:#403F53"> MAX_WAV_VALUE </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--1:#AA0982"><span style="--0:#F78C6C">32767.0</span><span style="--0:#FFEB95">f</span></span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">const</span><span style="--0:#D6DEEB;--1:#403F53"> std::string instanceName{</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">piper</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">std::string </span><span style="--0:#82AAFF;--1:#3B61B0">getVersion</span><span style="--0:#D6DEEB;--1:#403F53">() { </span><span style="--0:#C792EA;--1:#8844AE">return</span><span style="--0:#D6DEEB;--1:#403F53"> VERSION; }</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// True if the string is a single UTF-8 codepoint</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">bool</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">isSingleCodepoint</span><span style="--1:#403F53"><span style="--0:#D6DEEB">(std::string </span><span style="--0:#D7DBE0">s</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">return</span><span style="--0:#D6DEEB;--1:#403F53"> utf8::</span><span style="--0:#82AAFF;--1:#3B61B0">distance</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">s</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">begin</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">s</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">end</span><span style="--0:#D6DEEB;--1:#403F53">()) </span><span style="--0:#C792EA;--1:#8844AE">==</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Get the first UTF-8 codepoint of a string</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">Phoneme </span><span style="--0:#82AAFF;--1:#3B61B0">getCodepoint</span><span style="--1:#403F53"><span style="--0:#D6DEEB">(std::string </span><span style="--0:#D7DBE0">s</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">utf8::iterator </span><span style="--0:#82AAFF;--1:#3B61B0">character_iter</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">s</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">begin</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">s</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">begin</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">s</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">end</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">return</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">character_iter;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Load JSON config information for phonemization</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">parsePhonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">(json </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">configRoot</span><span style="--0:#D6DEEB">, PhonemizeConfig </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">phonemizeConfig</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     "espeak": {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "voice": "&#x3C;language code>"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     },</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     "phoneme_type": "&#x3C;espeak or text>",</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     "phoneme_map": {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "&#x3C;from phoneme>": ["&#x3C;to phoneme 1>", "&#x3C;to phoneme 2>", ...]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     },</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     "phoneme_id_map": {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "&#x3C;phoneme>": [&#x3C;id1>, &#x3C;id2>, ...]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     }</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// }</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">espeak</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> espeakValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">espeak</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">espeakValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">voice</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">eSpeak</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">voice</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">espeakValue</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">voice</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">std::string</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_type</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phonemeTypeStr </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_type</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">std::string</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (phonemeTypeStr </span><span style="--0:#C792EA;--1:#8844AE">==</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">text</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeType</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> TextPhonemes;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// phoneme to [id] map</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Maps phonemes to one or more phoneme ids (required).</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_id_map</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phonemeIdMapValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_id_map</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">fromPhonemeItem : </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIdMapValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">items</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string fromPhoneme </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">fromPhonemeItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">key</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#82AAFF;--1:#3B61B0">isSingleCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(fromPhoneme)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">std::stringstream idsStr;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">toIdValue : </span><span style="--0:#C5E478;--1:#3B61B0">fromPhonemeItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">          </span></span><span style="--0:#D6DEEB;--1:#403F53">PhonemeId toId </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">toIdValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">PhonemeId</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">          </span></span><span style="--0:#D6DEEB;--1:#403F53">idsStr </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> toId </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">,</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">error</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D">{}</span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D"> is not a single codepoint (ids={})</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, fromPhoneme,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                      </span><span style="--0:#C5E478;--1:#3B61B0">idsStr</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">str</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Phonemes must be one codepoint (phoneme id map)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> fromCodepoint </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">getCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(fromPhoneme);</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">toIdValue : </span><span style="--0:#C5E478;--1:#3B61B0">fromPhonemeItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">PhonemeId toId </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">toIdValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">PhonemeId</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C5E478;--1:#3B61B0">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeIdMap</span><span style="--0:#D6DEEB;--1:#403F53">[fromCodepoint].</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(toId);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// phoneme to [phoneme] map</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Maps phonemes to one or more other phonemes (not normally used).</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_map</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#C5E478;--1:#3B61B0">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeMap</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">phonemeMap</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">emplace</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phonemeMapValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_map</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">fromPhonemeItem : </span><span style="--0:#C5E478;--1:#3B61B0">phonemeMapValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">items</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string fromPhoneme </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">fromPhonemeItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">key</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#82AAFF;--1:#3B61B0">isSingleCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(fromPhoneme)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">error</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D">{}</span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D"> is not a single codepoint</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, fromPhoneme);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Phonemes must be one codepoint (phoneme map)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> fromCodepoint </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">getCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(fromPhoneme);</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">toPhonemeValue : </span><span style="--0:#C5E478;--1:#3B61B0">fromPhonemeItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string toPhoneme </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">toPhonemeValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">std::string</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#82AAFF;--1:#3B61B0">isSingleCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(toPhoneme)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Phonemes must be one codepoint (phoneme map)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> toCodepoint </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">getCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(toPhoneme);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#C5E478;--1:#3B61B0">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeMap</span><span style="--0:#D6DEEB;--1:#403F53">)[fromCodepoint].</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(toCodepoint);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5F636F"> /* parsePhonemizeConfig */</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Load JSON config for audio synthesis</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">parseSynthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">(json </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">configRoot</span><span style="--0:#D6DEEB">, SynthesisConfig </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">synthesisConfig</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     "audio": {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "sample_rate": 22050</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     },</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     "inference": {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "noise_scale": 0.667,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "length_scale": 1,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "noise_w": 0.8,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         "phoneme_silence": {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//           "&#x3C;phoneme>": &#x3C;seconds of silence>,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//           ...</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//         }</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     }</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// }</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">audio</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> audioValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">audio</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">audioValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">sample_rate</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// Default sample rate is 22050 Hz</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sampleRate</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">audioValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">sample_rate</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#F78C6C;--1:#AA0982">22050</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">inference</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Overrides default inference settings</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> inferenceValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">inference</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">noise_scale</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">noiseScale</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">noise_scale</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--1:#AA0982"><span style="--0:#F78C6C">0.667</span><span style="--0:#FFEB95">f</span></span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">length_scale</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">lengthScale</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">length_scale</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--1:#AA0982"><span style="--0:#F78C6C">1.0</span><span style="--0:#FFEB95">f</span></span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">noise_w</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">noiseW</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">noise_w</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--1:#AA0982"><span style="--0:#F78C6C">0.8</span><span style="--0:#FFEB95">f</span></span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_silence</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// phoneme -> seconds of silence to add after</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">phonemeSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">emplace</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phonemeSilenceValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">inferenceValue</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">phoneme_silence</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">phonemeItem : </span><span style="--0:#C5E478;--1:#3B61B0">phonemeSilenceValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">items</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string phonemeStr </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phonemeItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">key</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#82AAFF;--1:#3B61B0">isSingleCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(phonemeStr)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">          </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">error</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D">{}</span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D"> is not a single codepoint</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, phonemeStr);</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Phonemes must be one codepoint (phoneme silence)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phoneme </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">getCodepoint</span><span style="--0:#D6DEEB;--1:#403F53">(phonemeStr);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53">)[phoneme] </span><span style="--0:#C792EA;--1:#8844AE">=</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#C5E478;--1:#3B61B0">phonemeItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">().</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;float></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5D6376"> // if phoneme_silence</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5D6376"> // if inference</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5F636F"> /* parseSynthesisConfig */</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">parseModelConfig</span><span style="--0:#D6DEEB;--1:#403F53">(json </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">configRoot</span><span style="--0:#D6DEEB">, ModelConfig </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">modelConfig</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">modelConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">numSpeakers</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">num_speakers</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">SpeakerId</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">contains</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">speaker_id_map</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#C5E478;--1:#3B61B0">modelConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">speakerIdMap</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">modelConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">speakerIdMap</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">emplace</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> speakerIdMapValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">speaker_id_map</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">speakerItem : </span><span style="--0:#C5E478;--1:#3B61B0">speakerIdMapValue</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">items</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string speakerName </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">speakerItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">key</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#C5E478;--1:#3B61B0">modelConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">speakerIdMap</span><span style="--0:#D6DEEB;--1:#403F53">)[speakerName] </span><span style="--0:#C792EA;--1:#8844AE">=</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#C5E478;--1:#3B61B0">speakerItem</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">().</span><span style="--0:#7FDBCA;--1:#096E72">get</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">SpeakerId</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5F636F"> /* parseModelConfig */</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">initialize</span><span style="--0:#D6DEEB;--1:#403F53">(PiperConfig </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">config</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">useESpeak</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Set up espeak-ng for calling espeak_TextToPhonemesWithTerminator</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// See: https://github.com/rhasspy/espeak-ng</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Initializing eSpeak</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">int</span><span style="--0:#D6DEEB;--1:#403F53"> result </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">espeak_Initialize</span><span style="--0:#D6DEEB;--1:#403F53">(AUDIO_OUTPUT_SYNCHRONOUS,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5F636F">                                   </span></span><span style="--0:#919F9F;--1:#5F636F">/*buflength*/</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5F636F">                                   </span></span><span style="--0:#919F9F;--1:#5F636F">/*path*/</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">eSpeakDataPath</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">c_str</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5F636F">                                   </span></span><span style="--0:#919F9F;--1:#5F636F">/*options*/</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (result </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Failed to initialize eSpeak-ng</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Initialized eSpeak</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Load onnx model for libtashkeel</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// https://github.com/mush42/libtashkeel/</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">useTashkeel</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Using libtashkeel for diacritization</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">tashkeelModelPath</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">No path to libtashkeel model</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Loading libtashkeel model from {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">tashkeelModelPath</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">tashkeelState</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">make_unique</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;tashkeel::State>();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">tashkeel::</span><span style="--0:#82AAFF;--1:#3B61B0">tashkeel_load</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">tashkeelModelPath</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">tashkeelState</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Initialized libtashkeel</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">info</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Initialized piper</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">terminate</span><span style="--0:#D6DEEB;--1:#403F53">(PiperConfig </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">config</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">useESpeak</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Clean up espeak-ng</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Terminating eSpeak</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">espeak_Terminate</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Terminated eSpeak</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">info</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Terminated piper</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">loadModel</span><span style="--1:#403F53"><span style="--0:#D6DEEB">(std::string </span><span style="--0:#D7DBE0">modelPath</span><span style="--0:#D6DEEB">, ModelSession </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">session</span><span style="--0:#D6DEEB">, </span></span><span style="--0:#C792EA;--1:#8844AE">bool</span><span style="--1:#403F53"><span style="--0:#D6DEEB"> </span><span style="--0:#D7DBE0">useCuda</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Loading onnx model from {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, modelPath);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">env</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> Ort::</span><span style="--0:#82AAFF;--1:#3B61B0">Env</span><span style="--0:#D6DEEB;--1:#403F53">(OrtLoggingLevel::ORT_LOGGING_LEVEL_WARNING,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                         </span><span style="--0:#C5E478;--1:#3B61B0">instanceName</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">c_str</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">env</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">DisableTelemetryEvents</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (useCuda) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Use CUDA provider</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">OrtCUDAProviderOptions cuda_options{};</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">cuda_options</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">cudnn_conv_algo_search</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> OrtCudnnConvAlgoSearchHeuristic;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">options</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">AppendExecutionProvider_CUDA</span><span style="--0:#D6DEEB;--1:#403F53">(cuda_options);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Slows down performance by ~2x</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// session.options.SetIntraOpNumThreads(1);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Roughly doubles load time for no visible inference benefit</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// session.options.SetGraphOptimizationLevel(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">//     GraphOptimizationLevel::ORT_ENABLE_EXTENDED);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">options</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">SetGraphOptimizationLevel</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">GraphOptimizationLevel::ORT_DISABLE_ALL);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Slows down performance very slightly</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// session.options.SetExecutionMode(ExecutionMode::ORT_PARALLEL);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">options</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">DisableCpuMemArena</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">options</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">DisableMemPattern</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">options</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">DisableProfiling</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> startTime </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::chrono::steady_clock::</span><span style="--0:#82AAFF;--1:#3B61B0">now</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#ifdef</span><span style="--0:#D6DEEB;--1:#403F53"> _WIN32</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> modelPathW </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">wstring</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">modelPath</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">begin</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">modelPath</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">end</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> modelPathStr </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">modelPathW</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">c_str</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#else</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> modelPathStr </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">modelPath</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">c_str</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">#endif</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">onnx</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> Ort::</span><span style="--0:#82AAFF;--1:#3B61B0">Session</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">env</span><span style="--0:#D6DEEB;--1:#403F53">, modelPathStr, </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">options</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> endTime </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::chrono::steady_clock::</span><span style="--0:#82AAFF;--1:#3B61B0">now</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Loaded onnx model in {} second(s)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                </span></span><span style="--0:#D6DEEB;--1:#403F53">std::chrono::</span><span style="--0:#82AAFF;--1:#3B61B0">duration</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">double</span><span style="--0:#D6DEEB;--1:#403F53">>(endTime </span><span style="--0:#C792EA;--1:#8844AE">-</span><span style="--0:#D6DEEB;--1:#403F53"> startTime).</span><span style="--0:#82AAFF;--1:#3B61B0">count</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Load Onnx model and JSON config file</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">loadVoice</span><span style="--0:#D6DEEB;--1:#403F53">(PiperConfig </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">config</span><span style="--0:#D6DEEB">, std::string </span><span style="--0:#D7DBE0">modelPath</span><span style="--0:#D6DEEB">,</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">               </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string </span><span style="--0:#D7DBE0;--1:#403F53">modelConfigPath</span><span style="--0:#D6DEEB;--1:#403F53">, Voice </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">voice</span><span style="--0:#D6DEEB">,</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">               </span></span><span style="--0:#D6DEEB;--1:#403F53">std::optional&#x3C;SpeakerId> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">speakerId</span><span style="--0:#D6DEEB">, </span></span><span style="--0:#C792EA;--1:#8844AE">bool</span><span style="--1:#403F53"><span style="--0:#D6DEEB"> </span><span style="--0:#D7DBE0">useCuda</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Parsing voice config at {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, modelConfigPath);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::ifstream </span><span style="--0:#82AAFF;--1:#3B61B0">modelConfigFile</span><span style="--0:#D6DEEB;--1:#403F53">(modelConfigPath);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">configRoot</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> json::</span><span style="--0:#82AAFF;--1:#3B61B0">parse</span><span style="--0:#D6DEEB;--1:#403F53">(modelConfigFile);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">parsePhonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">parseSynthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">parseModelConfig</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">configRoot</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">modelConfig</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">modelConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">numSpeakers</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Multi-speaker model</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (speakerId) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">speakerId</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> speakerId;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">} </span><span style="--0:#C792EA;--1:#8844AE">else</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// Default speaker</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">speakerId</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Voice contains {} speaker(s)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">modelConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">numSpeakers</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">loadModel</span><span style="--0:#D6DEEB;--1:#403F53">(modelPath, </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">session</span><span style="--0:#D6DEEB;--1:#403F53">, useCuda);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5F636F"> /* loadVoice */</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Phoneme ids to WAV audio</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">synthesize</span><span style="--0:#D6DEEB;--1:#403F53">(std::vector&#x3C;PhonemeId> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">phonemeIds</span><span style="--0:#D6DEEB">,</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                </span></span><span style="--0:#D6DEEB;--1:#403F53">SynthesisConfig </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">synthesisConfig</span><span style="--0:#D6DEEB">, ModelSession </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">session</span><span style="--0:#D6DEEB">,</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">int16_t</span><span style="--0:#D6DEEB;--1:#403F53">> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">audioBuffer</span><span style="--0:#D6DEEB">, SynthesisResult </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">result</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Synthesizing audio for {} phoneme id(s)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> memoryInfo </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> Ort::MemoryInfo::</span><span style="--0:#82AAFF;--1:#3B61B0">CreateCpu</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">OrtAllocatorType::OrtArenaAllocator, OrtMemType::OrtMemTypeDefault);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Allocate</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int64_t></span><span style="--0:#D6DEEB;--1:#403F53"> phonemeIdLengths{(</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()};</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;float></span><span style="--0:#D6DEEB;--1:#403F53"> scales{</span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">noiseScale</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">lengthScale</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">noiseW</span><span style="--0:#D6DEEB;--1:#403F53">};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">Ort::Value</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> inputTensors;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int64_t></span><span style="--0:#D6DEEB;--1:#403F53"> phonemeIdsShape{</span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#D6DEEB;--1:#403F53">, (</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()};</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(Ort::Value::</span><span style="--0:#82AAFF;--1:#3B61B0">CreateTensor</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">>(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">memoryInfo, </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIdsShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIdsShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int64_t></span><span style="--0:#D6DEEB;--1:#403F53"> phomemeIdLengthsShape{(</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">phonemeIdLengths</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()};</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(Ort::Value::</span><span style="--0:#82AAFF;--1:#3B61B0">CreateTensor</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">>(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">memoryInfo, </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIdLengths</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIdLengths</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phomemeIdLengthsShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">phomemeIdLengthsShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int64_t></span><span style="--0:#D6DEEB;--1:#403F53"> scalesShape{(</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">scales</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()};</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">Ort::Value::</span><span style="--0:#82AAFF;--1:#3B61B0">CreateTensor</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">float</span><span style="--0:#D6DEEB;--1:#403F53">>(memoryInfo, </span><span style="--0:#C5E478;--1:#3B61B0">scales</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">scales</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">                                      </span><span style="--0:#C5E478;--1:#3B61B0">scalesShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">scalesShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Add speaker id.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// NOTE: These must be kept outside the "if" below to avoid being deallocated.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int64_t></span><span style="--0:#D6DEEB;--1:#403F53"> speakerId{</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">speakerId</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">value_or</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">)};</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int64_t></span><span style="--0:#D6DEEB;--1:#403F53"> speakerIdShape{(</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">speakerId</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">speakerId</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(Ort::Value::</span><span style="--0:#82AAFF;--1:#3B61B0">CreateTensor</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53">>(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">memoryInfo, </span><span style="--0:#C5E478;--1:#3B61B0">speakerId</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">speakerId</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">speakerIdShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C5E478;--1:#3B61B0">speakerIdShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// From export_onnx.py</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::array</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;const</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">char</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#F78C6C;--1:#AA0982">4</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> inputNames </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> {</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">input</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">input_lengths</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">scales</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                                            </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">sid</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">};</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::array</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;const</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">char</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> outputNames </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> {</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">output</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Infer</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> startTime </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::chrono::steady_clock::</span><span style="--0:#82AAFF;--1:#3B61B0">now</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> outputTensors </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">session</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">onnx</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">Run</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">Ort::RunOptions{</span><span style="--0:#82AAFF;--1:#3B61B0">nullptr</span><span style="--0:#D6DEEB;--1:#403F53">}, </span><span style="--0:#C5E478;--1:#3B61B0">inputNames</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">outputNames</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">outputNames</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> endTime </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::chrono::steady_clock::</span><span style="--0:#82AAFF;--1:#3B61B0">now</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> ((</span><span style="--0:#C5E478;--1:#3B61B0">outputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#C792EA;--1:#8844AE">!=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#C792EA;--1:#8844AE">||</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#C5E478;--1:#3B61B0">outputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">front</span><span style="--0:#D6DEEB;--1:#403F53">().</span><span style="--0:#82AAFF;--1:#3B61B0">IsTensor</span><span style="--0:#D6DEEB;--1:#403F53">())) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Invalid output tensors</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> inferDuration </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::chrono::</span><span style="--0:#82AAFF;--1:#3B61B0">duration</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">double</span><span style="--0:#D6DEEB;--1:#403F53">>(endTime </span><span style="--0:#C792EA;--1:#8844AE">-</span><span style="--0:#D6DEEB;--1:#403F53"> startTime);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">inferSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">inferDuration</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">count</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">const</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">float</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">audio </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">outputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">front</span><span style="--0:#D6DEEB;--1:#403F53">().</span><span style="--0:#7FDBCA;--1:#096E72">GetTensorData</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;float></span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> audioShape </span><span style="--0:#C792EA;--1:#8844AE">=</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">outputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">front</span><span style="--0:#D6DEEB;--1:#403F53">().</span><span style="--0:#82AAFF;--1:#3B61B0">GetTensorTypeAndShapeInfo</span><span style="--0:#D6DEEB;--1:#403F53">().</span><span style="--0:#82AAFF;--1:#3B61B0">GetShape</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53"> audioCount </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">audioShape</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#C5E478;--1:#3B61B0">audioShape</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#C792EA;--1:#8844AE">-</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">double</span><span style="--0:#D6DEEB;--1:#403F53">)audioCount </span><span style="--0:#C792EA;--1:#8844AE">/</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">double</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sampleRate</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">realTimeFactor</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0.0</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">realTimeFactor</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">inferSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">/</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Synthesized {} second(s) of audio in {} second(s)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">inferSeconds</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Get max audio value for scaling</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">float</span><span style="--0:#D6DEEB;--1:#403F53"> maxAudioValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--1:#AA0982"><span style="--0:#F78C6C">0.01</span><span style="--0:#FFEB95">f</span></span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53"> i </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">; i </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> audioCount; i</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">float</span><span style="--0:#D6DEEB;--1:#403F53"> audioValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">abs</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">audio</span><span style="--0:#D6DEEB;--1:#403F53">[i]);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (audioValue </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> maxAudioValue) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">maxAudioValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> audioValue;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// We know the size up front</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">reserve</span><span style="--0:#D6DEEB;--1:#403F53">(audioCount);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Scale audio to fill range and convert to int16</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">float</span><span style="--0:#D6DEEB;--1:#403F53"> audioScale </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> (MAX_WAV_VALUE </span><span style="--0:#C792EA;--1:#8844AE">/</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">max</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--1:#AA0982"><span style="--0:#F78C6C">0.01</span><span style="--0:#FFEB95">f</span></span><span style="--0:#D6DEEB;--1:#403F53">, maxAudioValue));</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">int64_t</span><span style="--0:#D6DEEB;--1:#403F53"> i </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">; i </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> audioCount; i</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">int16_t</span><span style="--0:#D6DEEB;--1:#403F53"> intAudioValue </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">static_cast</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int16_t></span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">std::</span><span style="--0:#82AAFF;--1:#3B61B0">clamp</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">audio</span><span style="--0:#D6DEEB;--1:#403F53">[i] </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53"> audioScale,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                   </span><span style="--0:#7FDBCA;--1:#096E72">static_cast</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;float></span><span style="--0:#D6DEEB;--1:#403F53">(std::numeric_limits&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">int16_t</span><span style="--0:#D6DEEB;--1:#403F53">>::</span><span style="--0:#82AAFF;--1:#3B61B0">min</span><span style="--0:#D6DEEB;--1:#403F53">()),</span></div></div><div class="ec-line"><div class="code"><span class="indent">                   </span><span style="--0:#7FDBCA;--1:#096E72">static_cast</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;float></span><span style="--0:#D6DEEB;--1:#403F53">(std::numeric_limits&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">int16_t</span><span style="--0:#D6DEEB;--1:#403F53">>::</span><span style="--0:#82AAFF;--1:#3B61B0">max</span><span style="--0:#D6DEEB;--1:#403F53">())));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(intAudioValue);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Clean up</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (std::</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53"> i </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">; i </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">outputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(); i</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">Ort::detail::</span><span style="--0:#82AAFF;--1:#3B61B0">OrtRelease</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">outputTensors</span><span style="--0:#D6DEEB;--1:#403F53">[i].</span><span style="--0:#82AAFF;--1:#3B61B0">release</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (std::</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53"> i </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">; i </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(); i</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">Ort::detail::</span><span style="--0:#82AAFF;--1:#3B61B0">OrtRelease</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">inputTensors</span><span style="--0:#D6DEEB;--1:#403F53">[i].</span><span style="--0:#82AAFF;--1:#3B61B0">release</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// ----------------------------------------------------------------------------</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Phonemize text and synthesize audio</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">textToAudio</span><span style="--0:#D6DEEB;--1:#403F53">(PiperConfig </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">config</span><span style="--0:#D6DEEB">, Voice </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">voice</span><span style="--0:#D6DEEB">, std::string </span><span style="--0:#D7DBE0">text</span><span style="--0:#D6DEEB">,</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                 </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">int16_t</span><span style="--0:#D6DEEB;--1:#403F53">> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">audioBuffer</span><span style="--0:#D6DEEB">, SynthesisResult </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">result</span><span style="--0:#D6DEEB">,</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">                 </span><span style="--0:#C792EA;--1:#8844AE">const</span><span style="--0:#D6DEEB;--1:#403F53"> std::function&#x3C;</span><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53">()> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">audioCallback</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53"> sentenceSilenceSamples </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sentenceSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">sentenceSilenceSamples </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> (std::</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53">)(</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sentenceSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sampleRate</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">channels</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">useTashkeel</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">!</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">tashkeelState</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">throw</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">runtime_error</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Tashkeel model is not loaded</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Diacritizing text with libtashkeel: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, text);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">text </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> tashkeel::</span><span style="--0:#82AAFF;--1:#3B61B0">tashkeel_run</span><span style="--0:#D6DEEB;--1:#403F53">(text, </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">tashkeelState</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Phonemes for each sentence</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Phonemizing text: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, text);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">Phoneme</span><span style="--0:#C792EA;--1:#8844AE">>></span><span style="--0:#D6DEEB;--1:#403F53"> phonemes;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeType</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">==</span><span style="--0:#D6DEEB;--1:#403F53"> eSpeakPhonemes) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Use espeak-ng for phonemization</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">eSpeakPhonemeConfig eSpeakConfig;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">eSpeakConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">voice</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">eSpeak</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">voice</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">phonemize_eSpeak</span><span style="--0:#D6DEEB;--1:#403F53">(text, eSpeakConfig, phonemes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">} </span><span style="--0:#C792EA;--1:#8844AE">else</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Use UTF-8 codepoints as "phonemes"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">CodepointsPhonemeConfig codepointsConfig;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">phonemize_codepoints</span><span style="--0:#D6DEEB;--1:#403F53">(text, codepointsConfig, phonemes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Synthesize each sentence independently.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">PhonemeId</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> phonemeIds;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::map</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">Phoneme, std::</span><span style="--0:#C792EA;--1:#8844AE">size_t></span><span style="--0:#D6DEEB;--1:#403F53"> missingPhonemes;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phonemesIter </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">begin</span><span style="--0:#D6DEEB;--1:#403F53">(); phonemesIter </span><span style="--0:#C792EA;--1:#8844AE">!=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">end</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">phonemesIter) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">Phoneme</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">sentencePhonemes </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">phonemesIter;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">should_log</span><span style="--0:#D6DEEB;--1:#403F53">(spdlog::level::debug)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// DEBUG log for phonemes</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string phonemesStr;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phoneme : sentencePhonemes) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">utf8::</span><span style="--0:#82AAFF;--1:#3B61B0">append</span><span style="--0:#D6DEEB;--1:#403F53">(phoneme, std::</span><span style="--0:#82AAFF;--1:#3B61B0">back_inserter</span><span style="--0:#D6DEEB;--1:#403F53">(phonemesStr));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Converting {} phoneme(s) to ids: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                    </span><span style="--0:#C5E478;--1:#3B61B0">sentencePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(), phonemesStr);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">std::shared_ptr</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">Phoneme</span><span style="--0:#C792EA;--1:#8844AE">>>></span><span style="--0:#D6DEEB;--1:#403F53"> phrasePhonemes;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">SynthesisResult</span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> phraseResults;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;size_t></span><span style="--0:#D6DEEB;--1:#403F53"> phraseSilenceSamples;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Use phoneme/id map from config</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">PhonemeIdConfig idConfig;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">idConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeIdMap</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">std::</span><span style="--0:#82AAFF;--1:#3B61B0">make_shared</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;PhonemeIdMap>(</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">phonemizeConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeIdMap</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// Split into phrases</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">std::map</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53">Phoneme, </span><span style="--0:#C792EA;--1:#8844AE">float></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">phonemeSilenceSeconds </span><span style="--0:#C792EA;--1:#8844AE">=</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">phonemeSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> currentPhrasePhonemes </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">make_shared</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;std::vector&#x3C;Phoneme>>();</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(currentPhrasePhonemes);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> sentencePhonemesIter </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">sentencePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">begin</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">           </span></span><span style="--0:#D6DEEB;--1:#403F53">sentencePhonemesIter </span><span style="--0:#C792EA;--1:#8844AE">!=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">sentencePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">end</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">           </span></span><span style="--0:#D6DEEB;--1:#403F53">sentencePhonemesIter</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">Phoneme </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">currentPhoneme </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">sentencePhonemesIter;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C5E478;--1:#3B61B0">currentPhrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">-></span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(currentPhoneme);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">phonemeSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">count</span><span style="--0:#D6DEEB;--1:#403F53">(currentPhoneme) </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">          </span></span><span style="--0:#919F9F;--1:#5D6376">// Split at phrase boundary</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#C5E478;--1:#3B61B0">phraseSilenceSamples</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">              </span></span><span style="--0:#D6DEEB;--1:#403F53">(std::</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53">)(</span><span style="--0:#C5E478;--1:#3B61B0">phonemeSilenceSeconds</span><span style="--0:#D6DEEB;--1:#403F53">[currentPhoneme] </span><span style="--0:#C792EA;--1:#8844AE">*</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sampleRate</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#FAF39F;--1:#111111">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">channels</span><span style="--0:#D6DEEB;--1:#403F53">));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">          </span></span><span style="--0:#D6DEEB;--1:#403F53">currentPhrasePhonemes </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> std::</span><span style="--0:#82AAFF;--1:#3B61B0">make_shared</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;std::vector&#x3C;Phoneme>>();</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(currentPhrasePhonemes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">} </span><span style="--0:#C792EA;--1:#8844AE">else</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// Use all phonemes</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">          </span></span><span style="--0:#D6DEEB;--1:#403F53">std::</span><span style="--0:#82AAFF;--1:#3B61B0">make_shared</span><span style="--0:#D6DEEB;--1:#403F53">&#x3C;std::vector&#x3C;Phoneme>>(sentencePhonemes));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Ensure results/samples are the same size</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">while</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">phraseResults</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phraseResults</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">emplace_back</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">while</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">phraseSilenceSamples</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phraseSilenceSamples</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// phonemes -> ids -> audio</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53"> phraseIdx </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">; phraseIdx </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(); phraseIdx</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">[phraseIdx]-></span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">continue</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// phonemes -> ids</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">phonemes_to_ids</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">[phraseIdx]), idConfig, phonemeIds,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                      </span></span><span style="--0:#D6DEEB;--1:#403F53">missingPhonemes);</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">should_log</span><span style="--0:#D6DEEB;--1:#403F53">(spdlog::level::debug)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">        </span></span><span style="--0:#919F9F;--1:#5D6376">// DEBUG log for phoneme ids</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">std::stringstream phonemeIdsStr;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phonemeId : phonemeIds) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">          </span></span><span style="--0:#D6DEEB;--1:#403F53">phonemeIdsStr </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> phonemeId </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">debug</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Converted {} phoneme(s) to {} phoneme id(s): {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                      </span><span style="--0:#C5E478;--1:#3B61B0">phrasePhonemes</span><span style="--0:#D6DEEB;--1:#403F53">[phraseIdx]-></span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(), </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">                      </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIdsStr</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">str</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// ids -> audio</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">synthesize</span><span style="--0:#D6DEEB;--1:#403F53">(phonemeIds, </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">session</span><span style="--0:#D6DEEB;--1:#403F53">, audioBuffer,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                 </span><span style="--0:#C5E478;--1:#3B61B0">phraseResults</span><span style="--0:#D6DEEB;--1:#403F53">[phraseIdx]);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// Add end of phrase silence</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (std::</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53"> i </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">; i </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phraseSilenceSamples</span><span style="--0:#D6DEEB;--1:#403F53">[phraseIdx]; i</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">+=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phraseResults</span><span style="--0:#D6DEEB;--1:#403F53">[phraseIdx].</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">inferSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">+=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">phraseResults</span><span style="--0:#D6DEEB;--1:#403F53">[phraseIdx].</span><span style="--0:#7FDBCA;--1:#096E72">inferSeconds</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">clear</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">    </span></span><span style="--0:#919F9F;--1:#5D6376">// Add end of sentence silence</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (sentenceSilenceSamples </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (std::</span><span style="--0:#C792EA;--1:#8844AE">size_t</span><span style="--0:#D6DEEB;--1:#403F53"> i </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">; i </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> sentenceSilenceSamples; i</span><span style="--0:#C792EA;--1:#8844AE">++</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">push_back</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (audioCallback) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">      </span></span><span style="--0:#919F9F;--1:#5D6376">// Call back must copy audio since it is cleared afterwards.</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">audioCallback</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">clear</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">phonemeIds</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">clear</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">missingPhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">warn</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Missing {} phoneme(s) from phoneme/id map!</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                 </span><span style="--0:#C5E478;--1:#3B61B0">missingPhonemes</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">for</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> phonemeCount : missingPhonemes) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">std::string phonemeStr;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">utf8::</span><span style="--0:#82AAFF;--1:#3B61B0">append</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">phonemeCount</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">first</span><span style="--0:#D6DEEB;--1:#403F53">, std::</span><span style="--0:#82AAFF;--1:#3B61B0">back_inserter</span><span style="--0:#D6DEEB;--1:#403F53">(phonemeStr));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">spdlog::</span><span style="--0:#82AAFF;--1:#3B61B0">warn</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Missing </span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D">{}</span><span style="--0:#F78C6C;--1:#AA0982">\"</span><span style="--0:#ECC48D;--1:#984E4D"> (</span><span style="--0:#F78C6C;--1:#AA0982">\\</span><span style="--0:#ECC48D;--1:#984E4D">u{:04X}): {} time(s)</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, phonemeStr,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                   </span></span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">uint32_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">phonemeCount</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">first</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">phonemeCount</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">second</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> (</span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">realTimeFactor</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">inferSeconds</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">/</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">audioSeconds</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5F636F"> /* textToAudio */</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Phonemize text and synthesize audio to WAV file</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">void</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">textToWavFile</span><span style="--0:#D6DEEB;--1:#403F53">(PiperConfig </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">config</span><span style="--0:#D6DEEB">, Voice </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">voice</span><span style="--0:#D6DEEB">, std::string </span><span style="--0:#D7DBE0">text</span><span style="--0:#D6DEEB">,</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                   </span></span><span style="--0:#D6DEEB;--1:#403F53">std::ostream </span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">audioFile</span><span style="--0:#D6DEEB">, SynthesisResult </span></span><span style="--0:#C792EA;--1:#8844AE">&#x26;</span><span style="--1:#403F53"><span style="--0:#D7DBE0">result</span><span style="--0:#D6DEEB">) {</span></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">std::vector</span><span style="--0:#C792EA;--1:#8844AE">&#x3C;int16_t></span><span style="--0:#D6DEEB;--1:#403F53"> audioBuffer;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">textToAudio</span><span style="--0:#D6DEEB;--1:#403F53">(config, voice, text, audioBuffer, result, </span><span style="--0:#82AAFF;--1:#3B61B0">NULL</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#919F9F;--1:#5D6376">  </span></span><span style="--0:#919F9F;--1:#5D6376">// Write WAV</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">auto</span><span style="--0:#D6DEEB;--1:#403F53"> synthesisConfig </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">voice</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">writeWavHeader</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sampleRate</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">sampleWidth</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                 </span><span style="--0:#C5E478;--1:#3B61B0">synthesisConfig</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">channels</span><span style="--0:#D6DEEB;--1:#403F53">, (</span><span style="--0:#C792EA;--1:#8844AE">int32_t</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">                 </span></span><span style="--0:#D6DEEB;--1:#403F53">audioFile);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">audioFile</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">write</span><span style="--0:#D6DEEB;--1:#403F53">((</span><span style="--0:#C792EA;--1:#8844AE">const</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">char</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">data</span><span style="--0:#D6DEEB;--1:#403F53">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#7FDBCA;--1:#096E72">sizeof</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">int16_t</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">audioBuffer</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53">());</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5F636F"> /* textToWavFile */</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span><span style="--0:#919F9F;--1:#5D6376"> // namespace piper</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#include <array>#include <chrono>#include <fstream>#include <limits>#include <sstream>#include <stdexcept>#include <espeak-ng/speak_lib.h>#include <onnxruntime_cxx_api.h>#include <spdlog/spdlog.h>#include &#x22;json.hpp&#x22;#include &#x22;piper.hpp&#x22;#include &#x22;utf8.h&#x22;#include &#x22;wavfile.hpp&#x22;namespace piper {#ifdef _PIPER_VERSION// https://stackoverflow.com/questions/47346133/how-to-use-a-define-inside-a-format-string#define _STR(x) #x#define STR(x) _STR(x)const std::string VERSION = STR(_PIPER_VERSION);#elseconst std::string VERSION = &#x22;&#x22;;#endif// Maximum value for 16-bit signed WAV sampleconst float MAX_WAV_VALUE = 32767.0f;const std::string instanceName{&#x22;piper&#x22;};std::string getVersion() { return VERSION; }// True if the string is a single UTF-8 codepointbool isSingleCodepoint(std::string s) {  return utf8::distance(s.begin(), s.end()) == 1;}// Get the first UTF-8 codepoint of a stringPhoneme getCodepoint(std::string s) {  utf8::iterator character_iter(s.begin(), s.begin(), s.end());  return *character_iter;}// Load JSON config information for phonemizationvoid parsePhonemizeConfig(json &#x26;configRoot, PhonemizeConfig &#x26;phonemizeConfig) {  // {  //     &#x22;espeak&#x22;: {  //         &#x22;voice&#x22;: &#x22;<language code>&#x22;  //     },  //     &#x22;phoneme_type&#x22;: &#x22;<espeak or text>&#x22;,  //     &#x22;phoneme_map&#x22;: {  //         &#x22;<from phoneme>&#x22;: [&#x22;<to phoneme 1>&#x22;, &#x22;<to phoneme 2>&#x22;, ...]  //     },  //     &#x22;phoneme_id_map&#x22;: {  //         &#x22;<phoneme>&#x22;: [<id1>, <id2>, ...]  //     }  // }  if (configRoot.contains(&#x22;espeak&#x22;)) {    auto espeakValue = configRoot[&#x22;espeak&#x22;];    if (espeakValue.contains(&#x22;voice&#x22;)) {      phonemizeConfig.eSpeak.voice = espeakValue[&#x22;voice&#x22;].get<std::string>();    }  }  if (configRoot.contains(&#x22;phoneme_type&#x22;)) {    auto phonemeTypeStr = configRoot[&#x22;phoneme_type&#x22;].get<std::string>();    if (phonemeTypeStr == &#x22;text&#x22;) {      phonemizeConfig.phonemeType = TextPhonemes;    }  }  // phoneme to [id] map  // Maps phonemes to one or more phoneme ids (required).  if (configRoot.contains(&#x22;phoneme_id_map&#x22;)) {    auto phonemeIdMapValue = configRoot[&#x22;phoneme_id_map&#x22;];    for (auto &#x26;fromPhonemeItem : phonemeIdMapValue.items()) {      std::string fromPhoneme = fromPhonemeItem.key();      if (!isSingleCodepoint(fromPhoneme)) {        std::stringstream idsStr;        for (auto &#x26;toIdValue : fromPhonemeItem.value()) {          PhonemeId toId = toIdValue.get<PhonemeId>();          idsStr << toId << &#x22;,&#x22;;        }        spdlog::error(&#x22;\&#x22;{}\&#x22; is not a single codepoint (ids={})&#x22;, fromPhoneme,                      idsStr.str());        throw std::runtime_error(            &#x22;Phonemes must be one codepoint (phoneme id map)&#x22;);      }      auto fromCodepoint = getCodepoint(fromPhoneme);      for (auto &#x26;toIdValue : fromPhonemeItem.value()) {        PhonemeId toId = toIdValue.get<PhonemeId>();        phonemizeConfig.phonemeIdMap[fromCodepoint].push_back(toId);      }    }  }  // phoneme to [phoneme] map  // Maps phonemes to one or more other phonemes (not normally used).  if (configRoot.contains(&#x22;phoneme_map&#x22;)) {    if (!phonemizeConfig.phonemeMap) {      phonemizeConfig.phonemeMap.emplace();    }    auto phonemeMapValue = configRoot[&#x22;phoneme_map&#x22;];    for (auto &#x26;fromPhonemeItem : phonemeMapValue.items()) {      std::string fromPhoneme = fromPhonemeItem.key();      if (!isSingleCodepoint(fromPhoneme)) {        spdlog::error(&#x22;\&#x22;{}\&#x22; is not a single codepoint&#x22;, fromPhoneme);        throw std::runtime_error(            &#x22;Phonemes must be one codepoint (phoneme map)&#x22;);      }      auto fromCodepoint = getCodepoint(fromPhoneme);      for (auto &#x26;toPhonemeValue : fromPhonemeItem.value()) {        std::string toPhoneme = toPhonemeValue.get<std::string>();        if (!isSingleCodepoint(toPhoneme)) {          throw std::runtime_error(              &#x22;Phonemes must be one codepoint (phoneme map)&#x22;);        }        auto toCodepoint = getCodepoint(toPhoneme);        (*phonemizeConfig.phonemeMap)[fromCodepoint].push_back(toCodepoint);      }    }  }} /* parsePhonemizeConfig */// Load JSON config for audio synthesisvoid parseSynthesisConfig(json &#x26;configRoot, SynthesisConfig &#x26;synthesisConfig) {  // {  //     &#x22;audio&#x22;: {  //         &#x22;sample_rate&#x22;: 22050  //     },  //     &#x22;inference&#x22;: {  //         &#x22;noise_scale&#x22;: 0.667,  //         &#x22;length_scale&#x22;: 1,  //         &#x22;noise_w&#x22;: 0.8,  //         &#x22;phoneme_silence&#x22;: {  //           &#x22;<phoneme>&#x22;: <seconds of silence>,  //           ...  //         }  //     }  // }  if (configRoot.contains(&#x22;audio&#x22;)) {    auto audioValue = configRoot[&#x22;audio&#x22;];    if (audioValue.contains(&#x22;sample_rate&#x22;)) {      // Default sample rate is 22050 Hz      synthesisConfig.sampleRate = audioValue.value(&#x22;sample_rate&#x22;, 22050);    }  }  if (configRoot.contains(&#x22;inference&#x22;)) {    // Overrides default inference settings    auto inferenceValue = configRoot[&#x22;inference&#x22;];    if (inferenceValue.contains(&#x22;noise_scale&#x22;)) {      synthesisConfig.noiseScale = inferenceValue.value(&#x22;noise_scale&#x22;, 0.667f);    }    if (inferenceValue.contains(&#x22;length_scale&#x22;)) {      synthesisConfig.lengthScale = inferenceValue.value(&#x22;length_scale&#x22;, 1.0f);    }    if (inferenceValue.contains(&#x22;noise_w&#x22;)) {      synthesisConfig.noiseW = inferenceValue.value(&#x22;noise_w&#x22;, 0.8f);    }    if (inferenceValue.contains(&#x22;phoneme_silence&#x22;)) {      // phoneme -> seconds of silence to add after      synthesisConfig.phonemeSilenceSeconds.emplace();      auto phonemeSilenceValue = inferenceValue[&#x22;phoneme_silence&#x22;];      for (auto &#x26;phonemeItem : phonemeSilenceValue.items()) {        std::string phonemeStr = phonemeItem.key();        if (!isSingleCodepoint(phonemeStr)) {          spdlog::error(&#x22;\&#x22;{}\&#x22; is not a single codepoint&#x22;, phonemeStr);          throw std::runtime_error(              &#x22;Phonemes must be one codepoint (phoneme silence)&#x22;);        }        auto phoneme = getCodepoint(phonemeStr);        (*synthesisConfig.phonemeSilenceSeconds)[phoneme] =            phonemeItem.value().get<float>();      }    } // if phoneme_silence  } // if inference} /* parseSynthesisConfig */void parseModelConfig(json &#x26;configRoot, ModelConfig &#x26;modelConfig) {  modelConfig.numSpeakers = configRoot[&#x22;num_speakers&#x22;].get<SpeakerId>();  if (configRoot.contains(&#x22;speaker_id_map&#x22;)) {    if (!modelConfig.speakerIdMap) {      modelConfig.speakerIdMap.emplace();    }    auto speakerIdMapValue = configRoot[&#x22;speaker_id_map&#x22;];    for (auto &#x26;speakerItem : speakerIdMapValue.items()) {      std::string speakerName = speakerItem.key();      (*modelConfig.speakerIdMap)[speakerName] =          speakerItem.value().get<SpeakerId>();    }  }} /* parseModelConfig */void initialize(PiperConfig &#x26;config) {  if (config.useESpeak) {    // Set up espeak-ng for calling espeak_TextToPhonemesWithTerminator    // See: https://github.com/rhasspy/espeak-ng    spdlog::debug(&#x22;Initializing eSpeak&#x22;);    int result = espeak_Initialize(AUDIO_OUTPUT_SYNCHRONOUS,                                   /*buflength*/ 0,                                   /*path*/ config.eSpeakDataPath.c_str(),                                   /*options*/ 0);    if (result < 0) {      throw std::runtime_error(&#x22;Failed to initialize eSpeak-ng&#x22;);    }    spdlog::debug(&#x22;Initialized eSpeak&#x22;);  }  // Load onnx model for libtashkeel  // https://github.com/mush42/libtashkeel/  if (config.useTashkeel) {    spdlog::debug(&#x22;Using libtashkeel for diacritization&#x22;);    if (!config.tashkeelModelPath) {      throw std::runtime_error(&#x22;No path to libtashkeel model&#x22;);    }    spdlog::debug(&#x22;Loading libtashkeel model from {}&#x22;,                  config.tashkeelModelPath.value());    config.tashkeelState = std::make_unique<tashkeel::State>();    tashkeel::tashkeel_load(config.tashkeelModelPath.value(),                            *config.tashkeelState);    spdlog::debug(&#x22;Initialized libtashkeel&#x22;);  }  spdlog::info(&#x22;Initialized piper&#x22;);}void terminate(PiperConfig &#x26;config) {  if (config.useESpeak) {    // Clean up espeak-ng    spdlog::debug(&#x22;Terminating eSpeak&#x22;);    espeak_Terminate();    spdlog::debug(&#x22;Terminated eSpeak&#x22;);  }  spdlog::info(&#x22;Terminated piper&#x22;);}void loadModel(std::string modelPath, ModelSession &#x26;session, bool useCuda) {  spdlog::debug(&#x22;Loading onnx model from {}&#x22;, modelPath);  session.env = Ort::Env(OrtLoggingLevel::ORT_LOGGING_LEVEL_WARNING,                         instanceName.c_str());  session.env.DisableTelemetryEvents();  if (useCuda) {    // Use CUDA provider    OrtCUDAProviderOptions cuda_options{};    cuda_options.cudnn_conv_algo_search = OrtCudnnConvAlgoSearchHeuristic;    session.options.AppendExecutionProvider_CUDA(cuda_options);  }  // Slows down performance by ~2x  // session.options.SetIntraOpNumThreads(1);  // Roughly doubles load time for no visible inference benefit  // session.options.SetGraphOptimizationLevel(  //     GraphOptimizationLevel::ORT_ENABLE_EXTENDED);  session.options.SetGraphOptimizationLevel(      GraphOptimizationLevel::ORT_DISABLE_ALL);  // Slows down performance very slightly  // session.options.SetExecutionMode(ExecutionMode::ORT_PARALLEL);  session.options.DisableCpuMemArena();  session.options.DisableMemPattern();  session.options.DisableProfiling();  auto startTime = std::chrono::steady_clock::now();#ifdef _WIN32  auto modelPathW = std::wstring(modelPath.begin(), modelPath.end());  auto modelPathStr = modelPathW.c_str();#else  auto modelPathStr = modelPath.c_str();#endif  session.onnx = Ort::Session(session.env, modelPathStr, session.options);  auto endTime = std::chrono::steady_clock::now();  spdlog::debug(&#x22;Loaded onnx model in {} second(s)&#x22;,                std::chrono::duration<double>(endTime - startTime).count());}// Load Onnx model and JSON config filevoid loadVoice(PiperConfig &#x26;config, std::string modelPath,               std::string modelConfigPath, Voice &#x26;voice,               std::optional<SpeakerId> &#x26;speakerId, bool useCuda) {  spdlog::debug(&#x22;Parsing voice config at {}&#x22;, modelConfigPath);  std::ifstream modelConfigFile(modelConfigPath);  voice.configRoot = json::parse(modelConfigFile);  parsePhonemizeConfig(voice.configRoot, voice.phonemizeConfig);  parseSynthesisConfig(voice.configRoot, voice.synthesisConfig);  parseModelConfig(voice.configRoot, voice.modelConfig);  if (voice.modelConfig.numSpeakers > 1) {    // Multi-speaker model    if (speakerId) {      voice.synthesisConfig.speakerId = speakerId;    } else {      // Default speaker      voice.synthesisConfig.speakerId = 0;    }  }  spdlog::debug(&#x22;Voice contains {} speaker(s)&#x22;, voice.modelConfig.numSpeakers);  loadModel(modelPath, voice.session, useCuda);} /* loadVoice */// Phoneme ids to WAV audiovoid synthesize(std::vector<PhonemeId> &#x26;phonemeIds,                SynthesisConfig &#x26;synthesisConfig, ModelSession &#x26;session,                std::vector<int16_t> &#x26;audioBuffer, SynthesisResult &#x26;result) {  spdlog::debug(&#x22;Synthesizing audio for {} phoneme id(s)&#x22;, phonemeIds.size());  auto memoryInfo = Ort::MemoryInfo::CreateCpu(      OrtAllocatorType::OrtArenaAllocator, OrtMemType::OrtMemTypeDefault);  // Allocate  std::vector<int64_t> phonemeIdLengths{(int64_t)phonemeIds.size()};  std::vector<float> scales{synthesisConfig.noiseScale,                            synthesisConfig.lengthScale,                            synthesisConfig.noiseW};  std::vector<Ort::Value> inputTensors;  std::vector<int64_t> phonemeIdsShape{1, (int64_t)phonemeIds.size()};  inputTensors.push_back(Ort::Value::CreateTensor<int64_t>(      memoryInfo, phonemeIds.data(), phonemeIds.size(), phonemeIdsShape.data(),      phonemeIdsShape.size()));  std::vector<int64_t> phomemeIdLengthsShape{(int64_t)phonemeIdLengths.size()};  inputTensors.push_back(Ort::Value::CreateTensor<int64_t>(      memoryInfo, phonemeIdLengths.data(), phonemeIdLengths.size(),      phomemeIdLengthsShape.data(), phomemeIdLengthsShape.size()));  std::vector<int64_t> scalesShape{(int64_t)scales.size()};  inputTensors.push_back(      Ort::Value::CreateTensor<float>(memoryInfo, scales.data(), scales.size(),                                      scalesShape.data(), scalesShape.size()));  // Add speaker id.  // NOTE: These must be kept outside the &#x22;if&#x22; below to avoid being deallocated.  std::vector<int64_t> speakerId{      (int64_t)synthesisConfig.speakerId.value_or(0)};  std::vector<int64_t> speakerIdShape{(int64_t)speakerId.size()};  if (synthesisConfig.speakerId) {    inputTensors.push_back(Ort::Value::CreateTensor<int64_t>(        memoryInfo, speakerId.data(), speakerId.size(), speakerIdShape.data(),        speakerIdShape.size()));  }  // From export_onnx.py  std::array<const char *, 4> inputNames = {&#x22;input&#x22;, &#x22;input_lengths&#x22;, &#x22;scales&#x22;,                                            &#x22;sid&#x22;};  std::array<const char *, 1> outputNames = {&#x22;output&#x22;};  // Infer  auto startTime = std::chrono::steady_clock::now();  auto outputTensors = session.onnx.Run(      Ort::RunOptions{nullptr}, inputNames.data(), inputTensors.data(),      inputTensors.size(), outputNames.data(), outputNames.size());  auto endTime = std::chrono::steady_clock::now();  if ((outputTensors.size() != 1) || (!outputTensors.front().IsTensor())) {    throw std::runtime_error(&#x22;Invalid output tensors&#x22;);  }  auto inferDuration = std::chrono::duration<double>(endTime - startTime);  result.inferSeconds = inferDuration.count();  const float *audio = outputTensors.front().GetTensorData<float>();  auto audioShape =      outputTensors.front().GetTensorTypeAndShapeInfo().GetShape();  int64_t audioCount = audioShape[audioShape.size() - 1];  result.audioSeconds = (double)audioCount / (double)synthesisConfig.sampleRate;  result.realTimeFactor = 0.0;  if (result.audioSeconds > 0) {    result.realTimeFactor = result.inferSeconds / result.audioSeconds;  }  spdlog::debug(&#x22;Synthesized {} second(s) of audio in {} second(s)&#x22;,                result.audioSeconds, result.inferSeconds);  // Get max audio value for scaling  float maxAudioValue = 0.01f;  for (int64_t i = 0; i < audioCount; i++) {    float audioValue = abs(audio[i]);    if (audioValue > maxAudioValue) {      maxAudioValue = audioValue;    }  }  // We know the size up front  audioBuffer.reserve(audioCount);  // Scale audio to fill range and convert to int16  float audioScale = (MAX_WAV_VALUE / std::max(0.01f, maxAudioValue));  for (int64_t i = 0; i < audioCount; i++) {    int16_t intAudioValue = static_cast<int16_t>(        std::clamp(audio[i] * audioScale,                   static_cast<float>(std::numeric_limits<int16_t>::min()),                   static_cast<float>(std::numeric_limits<int16_t>::max())));    audioBuffer.push_back(intAudioValue);  }  // Clean up  for (std::size_t i = 0; i < outputTensors.size(); i++) {    Ort::detail::OrtRelease(outputTensors[i].release());  }  for (std::size_t i = 0; i < inputTensors.size(); i++) {    Ort::detail::OrtRelease(inputTensors[i].release());  }}// ----------------------------------------------------------------------------// Phonemize text and synthesize audiovoid textToAudio(PiperConfig &#x26;config, Voice &#x26;voice, std::string text,                 std::vector<int16_t> &#x26;audioBuffer, SynthesisResult &#x26;result,                 const std::function<void()> &#x26;audioCallback) {  std::size_t sentenceSilenceSamples = 0;  if (voice.synthesisConfig.sentenceSilenceSeconds > 0) {    sentenceSilenceSamples = (std::size_t)(        voice.synthesisConfig.sentenceSilenceSeconds *        voice.synthesisConfig.sampleRate * voice.synthesisConfig.channels);  }  if (config.useTashkeel) {    if (!config.tashkeelState) {      throw std::runtime_error(&#x22;Tashkeel model is not loaded&#x22;);    }    spdlog::debug(&#x22;Diacritizing text with libtashkeel: {}&#x22;, text);    text = tashkeel::tashkeel_run(text, *config.tashkeelState);  }  // Phonemes for each sentence  spdlog::debug(&#x22;Phonemizing text: {}&#x22;, text);  std::vector<std::vector<Phoneme>> phonemes;  if (voice.phonemizeConfig.phonemeType == eSpeakPhonemes) {    // Use espeak-ng for phonemization    eSpeakPhonemeConfig eSpeakConfig;    eSpeakConfig.voice = voice.phonemizeConfig.eSpeak.voice;    phonemize_eSpeak(text, eSpeakConfig, phonemes);  } else {    // Use UTF-8 codepoints as &#x22;phonemes&#x22;    CodepointsPhonemeConfig codepointsConfig;    phonemize_codepoints(text, codepointsConfig, phonemes);  }  // Synthesize each sentence independently.  std::vector<PhonemeId> phonemeIds;  std::map<Phoneme, std::size_t> missingPhonemes;  for (auto phonemesIter = phonemes.begin(); phonemesIter != phonemes.end();       ++phonemesIter) {    std::vector<Phoneme> &#x26;sentencePhonemes = *phonemesIter;    if (spdlog::should_log(spdlog::level::debug)) {      // DEBUG log for phonemes      std::string phonemesStr;      for (auto phoneme : sentencePhonemes) {        utf8::append(phoneme, std::back_inserter(phonemesStr));      }      spdlog::debug(&#x22;Converting {} phoneme(s) to ids: {}&#x22;,                    sentencePhonemes.size(), phonemesStr);    }    std::vector<std::shared_ptr<std::vector<Phoneme>>> phrasePhonemes;    std::vector<SynthesisResult> phraseResults;    std::vector<size_t> phraseSilenceSamples;    // Use phoneme/id map from config    PhonemeIdConfig idConfig;    idConfig.phonemeIdMap =        std::make_shared<PhonemeIdMap>(voice.phonemizeConfig.phonemeIdMap);    if (voice.synthesisConfig.phonemeSilenceSeconds) {      // Split into phrases      std::map<Phoneme, float> &#x26;phonemeSilenceSeconds =          *voice.synthesisConfig.phonemeSilenceSeconds;      auto currentPhrasePhonemes = std::make_shared<std::vector<Phoneme>>();      phrasePhonemes.push_back(currentPhrasePhonemes);      for (auto sentencePhonemesIter = sentencePhonemes.begin();           sentencePhonemesIter != sentencePhonemes.end();           sentencePhonemesIter++) {        Phoneme &#x26;currentPhoneme = *sentencePhonemesIter;        currentPhrasePhonemes->push_back(currentPhoneme);        if (phonemeSilenceSeconds.count(currentPhoneme) > 0) {          // Split at phrase boundary          phraseSilenceSamples.push_back(              (std::size_t)(phonemeSilenceSeconds[currentPhoneme] *                            voice.synthesisConfig.sampleRate *                            voice.synthesisConfig.channels));          currentPhrasePhonemes = std::make_shared<std::vector<Phoneme>>();          phrasePhonemes.push_back(currentPhrasePhonemes);        }      }    } else {      // Use all phonemes      phrasePhonemes.push_back(          std::make_shared<std::vector<Phoneme>>(sentencePhonemes));    }    // Ensure results/samples are the same size    while (phraseResults.size() < phrasePhonemes.size()) {      phraseResults.emplace_back();    }    while (phraseSilenceSamples.size() < phrasePhonemes.size()) {      phraseSilenceSamples.push_back(0);    }    // phonemes -> ids -> audio    for (size_t phraseIdx = 0; phraseIdx < phrasePhonemes.size(); phraseIdx++) {      if (phrasePhonemes[phraseIdx]->size() <= 0) {        continue;      }      // phonemes -> ids      phonemes_to_ids(*(phrasePhonemes[phraseIdx]), idConfig, phonemeIds,                      missingPhonemes);      if (spdlog::should_log(spdlog::level::debug)) {        // DEBUG log for phoneme ids        std::stringstream phonemeIdsStr;        for (auto phonemeId : phonemeIds) {          phonemeIdsStr << phonemeId << &#x22;, &#x22;;        }        spdlog::debug(&#x22;Converted {} phoneme(s) to {} phoneme id(s): {}&#x22;,                      phrasePhonemes[phraseIdx]->size(), phonemeIds.size(),                      phonemeIdsStr.str());      }      // ids -> audio      synthesize(phonemeIds, voice.synthesisConfig, voice.session, audioBuffer,                 phraseResults[phraseIdx]);      // Add end of phrase silence      for (std::size_t i = 0; i < phraseSilenceSamples[phraseIdx]; i++) {        audioBuffer.push_back(0);      }      result.audioSeconds += phraseResults[phraseIdx].audioSeconds;      result.inferSeconds += phraseResults[phraseIdx].inferSeconds;      phonemeIds.clear();    }    // Add end of sentence silence    if (sentenceSilenceSamples > 0) {      for (std::size_t i = 0; i < sentenceSilenceSamples; i++) {        audioBuffer.push_back(0);      }    }    if (audioCallback) {      // Call back must copy audio since it is cleared afterwards.      audioCallback();      audioBuffer.clear();    }    phonemeIds.clear();  }  if (missingPhonemes.size() > 0) {    spdlog::warn(&#x22;Missing {} phoneme(s) from phoneme/id map!&#x22;,                 missingPhonemes.size());    for (auto phonemeCount : missingPhonemes) {      std::string phonemeStr;      utf8::append(phonemeCount.first, std::back_inserter(phonemeStr));      spdlog::warn(&#x22;Missing \&#x22;{}\&#x22; (\\u{:04X}): {} time(s)&#x22;, phonemeStr,                   (uint32_t)phonemeCount.first, phonemeCount.second);    }  }  if (result.audioSeconds > 0) {    result.realTimeFactor = result.inferSeconds / result.audioSeconds;  }} /* textToAudio */// Phonemize text and synthesize audio to WAV filevoid textToWavFile(PiperConfig &#x26;config, Voice &#x26;voice, std::string text,                   std::ostream &#x26;audioFile, SynthesisResult &#x26;result) {  std::vector<int16_t> audioBuffer;  textToAudio(config, voice, text, audioBuffer, result, NULL);  // Write WAV  auto synthesisConfig = voice.synthesisConfig;  writeWavHeader(synthesisConfig.sampleRate, synthesisConfig.sampleWidth,                 synthesisConfig.channels, (int32_t)audioBuffer.size(),                 audioFile);  audioFile.write((const char *)audioBuffer.data(),                  sizeof(int16_t) * audioBuffer.size());} /* textToWavFile */} // namespace piper"><div></div></button></div></figure></div> </div> <footer class="sl-flex astro-3yyafb3n"> <div class="meta sl-flex astro-3yyafb3n">   </div> <div class="pagination-links print:hidden astro-u2l5gyhi" dir="ltr"> <a href="/piper-docs/codereading/cpp/main/" rel="prev" class="astro-u2l5gyhi"> <svg aria-hidden="true" class="astro-u2l5gyhi astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17 11H9.41l3.3-3.29a1.004 1.004 0 1 0-1.42-1.42l-5 5a1 1 0 0 0-.21.33 1 1 0 0 0 0 .76 1 1 0 0 0 .21.33l5 5a1.002 1.002 0 0 0 1.639-.325 1 1 0 0 0-.219-1.095L9.41 13H17a1 1 0 0 0 0-2Z"/></svg>  <span class="astro-u2l5gyhi"> Previous <br class="astro-u2l5gyhi"> <span class="link-title astro-u2l5gyhi">main.cpp</span> </span> </a> <a href="/piper-docs/codereading/python_run/piper/main/" rel="next" class="astro-u2l5gyhi"> <svg aria-hidden="true" class="astro-u2l5gyhi astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17.92 11.62a1.001 1.001 0 0 0-.21-.33l-5-5a1.003 1.003 0 1 0-1.42 1.42l3.3 3.29H7a1 1 0 0 0 0 2h7.59l-3.3 3.29a1.002 1.002 0 0 0 .325 1.639 1 1 0 0 0 1.095-.219l5-5a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76Z"/></svg>  <span class="astro-u2l5gyhi"> Next <br class="astro-u2l5gyhi"> <span class="link-title astro-u2l5gyhi">__main__.py</span> </span> </a> </div>   </footer>  </div> </div>   </main> </div> </div>  </div> </div>  </body></html>